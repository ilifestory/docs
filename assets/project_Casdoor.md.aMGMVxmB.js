import{_ as s,c as a,o as n,a4 as e,dz as p,dA as l}from"./chunks/framework.CCJHkvW2.js";const h=JSON.parse('{"title":"Casdoor 单点登录SSO 系统","description":"","frontmatter":{},"headers":[],"relativePath":"project/Casdoor.md","filePath":"project/Casdoor.md","lastUpdated":1715332530000}'),o={name:"project/Casdoor.md"},t=e('<h1 id="casdoor-单点登录sso-系统" tabindex="-1">Casdoor 单点登录SSO 系统 <a class="header-anchor" href="#casdoor-单点登录sso-系统" aria-label="Permalink to &quot;Casdoor 单点登录SSO 系统&quot;">​</a></h1><p>文档地址(<a href="https://casdoor.org/zh/docs/how-to-connect/oauth" target="_blank" rel="noreferrer">https://casdoor.org/zh/docs/how-to-connect/oauth</a>)</p><p>Casdoor 可为网页和应用程序用户的登录请求提供服务。基于OAuth2.0实现的SSO</p><p>Casdoor四个核心概念：Organization，User，Application和Provider。</p><h2 id="casdoor-的特性" tabindex="-1">Casdoor 的特性： <a class="header-anchor" href="#casdoor-的特性" aria-label="Permalink to &quot;Casdoor 的特性：&quot;">​</a></h2><p>Casdoor 遵循前后端分离架构，采用 Golang 进行开发。 它支持高同步，提供基于网页的用户界面管理，并支持10多种语言的本地化。</p><p>Casdoor 支持第三方应用登录，如 GitHub、谷歌、QQ、微信等，并支持通过插件扩展第三方登录。</p><p>Casdoor 支持基于 Cassbin 的授权管理。 它支持 ACL、RBAC、ABAC 和 RESTful鉴权管理模式。</p><p>Casdoor 提供了手机验证码、电子邮件验证码以及重置密码的功能。</p><p>Casdoor 支持日志的审计和记录。</p><p>Casdoor 可以使用阿里云、腾讯云、七牛云提供的图片CDN云存储功能。</p><p>Casdoor 允许自定义注册、登录以及找回密码页面。</p><p>通过数据库同步支持与现有系统的集成，从而能够顺利过渡到 Casdoor。</p><p>Casdoor 支持主流数据库: MySQL、PostgreSQL、SQL Server 等, 并支持扩展插件以支持新的数据库。</p><p><img src="'+p+`" alt="GIF动图"></p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> run</span><span style="color:#C3E88D;">  -d</span><span style="color:#C3E88D;"> -name</span><span style="color:#C3E88D;"> casdoor</span><span style="color:#C3E88D;"> -p</span><span style="color:#C3E88D;"> 18000:8000</span><span style="color:#C3E88D;"> -v</span><span style="color:#C3E88D;"> /docker/casdoor/conf/app.conf:/conf/app.conf</span><span style="color:#C3E88D;"> casbin/casdoor:latest</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">注意</p><p>先docker copy 容器的app.conf到本地</p></div><p>app.conf 配置文件</p><div class="language-text line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span>appname = casdoor</span></span>
<span class="line"><span>httpport = 8000</span></span>
<span class="line"><span>runmode = dev</span></span>
<span class="line"><span>copyrequestbody = true</span></span>
<span class="line"><span>driverName = mysql</span></span>
<span class="line"><span>dataSourceName = root:mysqlmysql@tcp(172.26.27.23:3306)/</span></span>
<span class="line"><span>dbName = casdoor</span></span>
<span class="line"><span>tableNamePrefix =</span></span>
<span class="line"><span>showSql = false</span></span>
<span class="line"><span>redisEndpoint =</span></span>
<span class="line"><span>defaultStorageProvider =</span></span>
<span class="line"><span>isCloudIntranet = false</span></span>
<span class="line"><span>authState = &quot;casdoor&quot;</span></span>
<span class="line"><span>socks5Proxy = &quot;127.0.0.1:10808&quot;</span></span>
<span class="line"><span>verificationCodeTimeout = 10</span></span>
<span class="line"><span>initScore = 0</span></span>
<span class="line"><span>logPostOnly = true</span></span>
<span class="line"><span>isUsernameLowered = false</span></span>
<span class="line"><span>origin =</span></span>
<span class="line"><span>originFrontend =</span></span>
<span class="line"><span>staticBaseUrl = &quot;https://cdn.casbin.org&quot;</span></span>
<span class="line"><span>isDemoMode = false</span></span>
<span class="line"><span>batchSize = 100</span></span>
<span class="line"><span>enableGzip = true</span></span>
<span class="line"><span>ldapServerPort = 389</span></span>
<span class="line"><span>radiusServerPort = 1812</span></span>
<span class="line"><span>radiusSecret = &quot;secret&quot;</span></span>
<span class="line"><span>quota = {&quot;organization&quot;: -1, &quot;user&quot;: -1, &quot;application&quot;: -1, &quot;provider&quot;: -1}</span></span>
<span class="line"><span>logConfig = {&quot;filename&quot;: &quot;logs/casdoor.log&quot;, &quot;maxdays&quot;:99999, &quot;perm&quot;:&quot;0770&quot;}</span></span>
<span class="line"><span>initDataFile = &quot;./init_data.json&quot;</span></span>
<span class="line"><span>frontendBaseDir = &quot;../casdoor&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>创建mysql数据库 <code>casdoor</code></p><p>账号密码</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">admin</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>123</p><p>查看OIDC配置(<code>OIDC: OpenID Connect</code>,<code>OAuth2.0的具体实现</code>)</p><div class="language-http line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">http://172.26.27.23:18000/.well-known/openid-configuration</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="casdoor是如何自我管理的" tabindex="-1">Casdoor是如何自我管理的？ <a class="header-anchor" href="#casdoor是如何自我管理的" aria-label="Permalink to &quot;Casdoor是如何自我管理的？&quot;">​</a></h2><p>首次运行Casdoor时，会创建一些内置对象以方便其管理：</p><div class="tip custom-block"><p class="custom-block-title">说明</p><p>组织： built-in</p><p>app：app-built-in</p><p>用户：admin</p></div><p>一个内置的命名为 built-in 的组织。</p><p>built-in 组织下用户名为 admin的用户 。</p><p>一个名为app-built-in的内置应用，由built-in组织管理，代表Casdoor本身。</p><p>built-in组织下的所有用户，包括admin，都将在Casdoor平台上拥有完全的管理员权限。 因此，如果有多个管理员，建议在built-in组织下创建新账户。 或者，应关闭app-built-in应用程序的注册通道，以防止不必要的访问。</p><div class="danger custom-block"><p class="custom-block-title">注意</p><p>无法通过网页用户界面或RESTful API重命名或删除内置对象。 Casdoor在许多地方硬编码了这些保留名称；尝试通过修改数据库来重命名或删除它们可能会导致整个系统崩溃。</p></div><h2 id="登录地址" tabindex="-1">登录地址 <a class="header-anchor" href="#登录地址" aria-label="Permalink to &quot;登录地址&quot;">​</a></h2><p>内置用户登录地址</p><div class="language-http line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">http://172.26.27.23:18000/login</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>指定组织登录地址 <a href="http://172.26.27.23:18000/login/organization_otn" target="_blank" rel="noreferrer">http://172.26.27.23:18000/login/organization_otn</a></p><ol><li>无后端服务方式</li></ol><p>示例登录地址</p><p><a href="https://door.casdoor.com/login/oauth/authorize?client_id=0ba528121ea87b3eb54d&amp;response_type=code&amp;redirect_uri=http://xxxxxx:9000/callback&amp;scope=read&amp;state=casdoor" target="_blank" rel="noreferrer">https://door.casdoor.com/login/oauth/authorize?client_id=0ba528121ea87b3eb54d&amp;response_type=code&amp;redirect_uri=http://xxxxxx:9000/callback&amp;scope=read&amp;state=casdoor</a></p><p><a href="http://172.26.27.23:18000/login/oauth/authorize?client_id=a7c02bcd12052195ca1c&amp;redirect_uri=http://172.26.25.4:88/otn-docs/&amp;response_type=token&amp;scope=openid&amp;state=OTN-Docs" target="_blank" rel="noreferrer">http://172.26.27.23:18000/login/oauth/authorize?client_id=a7c02bcd12052195ca1c&amp;redirect_uri=http://172.26.25.4:88/otn-docs/&amp;response_type=token&amp;scope=openid&amp;state=OTN-Docs</a></p><h2 id="文档中心" tabindex="-1">文档中心 <a class="header-anchor" href="#文档中心" aria-label="Permalink to &quot;文档中心&quot;">​</a></h2><div class="language-http line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">http://172.26.27.23:18000/login/oauth/authorize?client_id=a7c02bcd12052195ca1c&amp;redirect_uri=http://172.26.25.4:88/otn-docs/&amp;response_type=token&amp;scope=openid&amp;state=OTN-Docs</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>重定向后参数拼接地址如下：</p><p><a href="http://172.26.25.4:88/otn-docs/#access_token=xxxxxx&amp;state=OTN-Docs&amp;token_type=bearer" target="_blank" rel="noreferrer">http://172.26.25.4:88/otn-docs/#access_token=xxxxxx&amp;state=OTN-Docs&amp;token_type=bearer</a></p><h2 id="禅道" tabindex="-1">禅道 <a class="header-anchor" href="#禅道" aria-label="Permalink to &quot;禅道&quot;">​</a></h2><div class="language-http line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">http://172.26.27.23:18000/login/oauth/authorize?client_id=fa7b928608d3e5f1c9ed&amp;redirect_uri=http://172.26.25.4:8277/&amp;response_type=token&amp;scope=openid&amp;state=禅道</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Jenkins</p><div class="language-http line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">http://172.26.27.23:18000/login/oauth/authorize?client_id=bd61c593a6cc6f40ba0a&amp;redirect_uri=http://172.26.25.25:8080/securityRealm/finishLogin&amp;response_type=code&amp;scope=read&amp;state=application_jenkins_k8s</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">重要的几个URL地址/参数</p><p>Token server URL(获取Token URL)：http://CASDOOR_HOSTNAME/api/login/oauth/access_token</p><p>Authorization server URL(认证URL)：http://CASDOOR_HOSTNAME/login/oauth/authorize</p><p>UserInfo server URL(获取用户信息)：http://CASDOOR_HOSTNAME/api/get-account</p><p>Scopes(范围、作用域)：address phone openid profile offline_access email</p></div><h2 id="jenkins-集成-casdoor" tabindex="-1">jenkins 集成 Casdoor <a class="header-anchor" href="#jenkins-集成-casdoor" aria-label="Permalink to &quot;jenkins 集成 Casdoor&quot;">​</a></h2><p>casdoor平台创建应用</p><p>回调地址：</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">http://172.26.25.4:8080/jenkins/securityRealm/finishLogin</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">http://172.26.25.25:8080/securityRealm/finishLogin</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>jenkins平台下载插件<code>Casdoor</code></p><p>在全局安全配置-&gt;安全域，选择 &quot;Casdoor 认证插件&quot;。</p><p>在 Casdoor Endpoint字段中，输入前面提到的 CASDOOR_HOSTNAME(<a href="http://172.26.27.23:18000" target="_blank" rel="noreferrer">http://172.26.27.23:18000</a>)。</p><p>在 Client ID 字段中，输入前面提到的 Client ID(9bddd0932a2d6bbe6cdf)。</p><p>在 Client secret 字段中，输入前面提到的 Client secret(18c7a4f1f72917a5cce661c73c1dd5d671ebfa5a)。</p><p>在 JWT 公钥字段中，提供用于验证 JWT 令牌的公钥。 您可以通过点击 Casdoor 顶部的 身份认证-&gt;证书 找到公钥。 点击您的应用上的 edit 后，您可以从以下页面复制公钥，点击复制公钥。</p><h2 id="minio-集成-casdoor" tabindex="-1">Minio 集成 Casdoor <a class="header-anchor" href="#minio-集成-casdoor" aria-label="Permalink to &quot;Minio 集成 Casdoor&quot;">​</a></h2><p>参考文档(<a href="https://min.io/docs/minio/linux/operations/external-iam/configure-openid-external-identity-management.html" target="_blank" rel="noreferrer">https://min.io/docs/minio/linux/operations/external-iam/configure-openid-external-identity-management.html</a>)(<a href="https://casdoor.org/zh/docs/integration/go/minio" target="_blank" rel="noreferrer">https://casdoor.org/zh/docs/integration/go/minio</a>)</p><p>mc安装</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">curl</span><span style="color:#C3E88D;"> https://dl.min.io/client/mc/release/linux-amd64/mc</span><span style="color:#C3E88D;"> --create-dirs</span><span style="color:#C3E88D;"> -o</span><span style="color:#BABED8;"> $HOME</span><span style="color:#C3E88D;">/minio-binaries/mc</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">chmod</span><span style="color:#C3E88D;"> +x</span><span style="color:#BABED8;"> $HOME</span><span style="color:#C3E88D;">/minio-binaries/mc</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#C792EA;">export</span><span style="color:#BABED8;"> PATH</span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;">$PATH:$HOME/minio-binaries/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>测试</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mc</span><span style="color:#C3E88D;"> --help</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>配置别名alias（不是控制台地址，是服务地址）</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mc</span><span style="color:#C3E88D;"> alias</span><span style="color:#C3E88D;"> set</span><span style="color:#C3E88D;"> minio_zhangling</span><span style="color:#C3E88D;"> http://172.26.27.23:9011</span><span style="color:#C3E88D;"> miniominio</span><span style="color:#C3E88D;"> miniominio</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>配置OIDC</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mc</span><span style="color:#C3E88D;"> admin</span><span style="color:#C3E88D;"> config</span><span style="color:#C3E88D;"> set</span><span style="color:#C3E88D;"> minio_zhangling</span><span style="color:#C3E88D;"> identity_openid</span><span style="color:#C3E88D;"> config_url=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://172.26.27.23:18000/.well-known/openid-configuration</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> minio_browser_redirect_url=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://172.26.27.23:9010/oauth_callback</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> client_id=2ddb4674eab72412cb4e</span><span style="color:#C3E88D;"> client_secret=582ade793a11b8a8e365a68783c3f17f9a8c4913</span><span style="color:#C3E88D;"> claim_name=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">tag</span><span style="color:#89DDFF;">&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>或</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mc</span><span style="color:#C3E88D;"> admin</span><span style="color:#C3E88D;"> config</span><span style="color:#C3E88D;"> set</span><span style="color:#C3E88D;"> minio_zhangling</span><span style="color:#C3E88D;"> identity_openid</span><span style="color:#C3E88D;"> config_url=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://main.jtiiot.com:8001/.well-known/openid-configuration</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> minio_browser_redirect_url=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://172.26.27.23:9010/oauth_callback</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> client_id=2ddb4674eab72412cb4e</span><span style="color:#C3E88D;"> client_secret=582ade793a11b8a8e365a68783c3f17f9a8c4913</span><span style="color:#C3E88D;"> claim_name=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">tag</span><span style="color:#89DDFF;">&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>mc admin config set minio_3 identity_openid config_url=&quot;<a href="http://172.26.27.23:18000/.well-known/openid-configuration" target="_blank" rel="noreferrer">http://172.26.27.23:18000/.well-known/openid-configuration</a>&quot; minio_browser_redirect_url=&quot;<a href="http://172.26.25.16:6003/oauth_callback" target="_blank" rel="noreferrer">http://172.26.25.16:6003/oauth_callback</a>&quot; client_id=b649a46222c3487d503b client_secret=ad9b2793679c3377da0417660bd57f611c7b99e3 claim_name=&quot;tag&quot;</p><p>重启MinIO</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mc</span><span style="color:#C3E88D;"> admin</span><span style="color:#C3E88D;"> service</span><span style="color:#C3E88D;"> restart</span><span style="color:#C3E88D;"> minio_zhangling</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Cardoor上配置callback</p><div class="language-http line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">http://172.26.27.23:9010/oauth_callback</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">注意</p><p>回调地址是控制台地址，不是服务地址 跟设置别名刚好相反</p></div><p>Casdoor 用户信息加入tag <img src="`+l+`" alt="An image"></p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">readwrite</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="casdoor-集成-gitlab" tabindex="-1">Casdoor 集成 Gitlab <a class="header-anchor" href="#casdoor-集成-gitlab" aria-label="Permalink to &quot;Casdoor 集成 Gitlab&quot;">​</a></h2><p>参考文档(<a href="https://casdoor.org/zh/docs/integration/ruby/gitlab" target="_blank" rel="noreferrer">https://casdoor.org/zh/docs/integration/ruby/gitlab</a>)(<a href="https://archives.docs.gitlab.com/16.8/ee/administration/auth/oidc.html" target="_blank" rel="noreferrer">https://archives.docs.gitlab.com/16.8/ee/administration/auth/oidc.html</a>)</p><p>casdoor平台创建应用</p><p>修改casdoor的配置文件</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">origin</span><span style="color:#C3E88D;"> =</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">https://main.jtiiot.com:8001</span><span style="color:#89DDFF;">&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">注意</p><p>协议必须是https的</p></div><p>gitlab gitlab.rb 的配置</p><div class="language-ruby line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">gitlab_rails</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">omniauth_providers</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> [</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#   {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#     &quot;name&quot; =&gt; &quot;google_oauth2&quot;,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#     &quot;app_id&quot; =&gt; &quot;YOUR APP ID&quot;,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#     &quot;app_secret&quot; =&gt; &quot;YOUR APP SECRET&quot;,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#     &quot;args&quot; =&gt; { &quot;access_type&quot; =&gt; &quot;offline&quot;, &quot;approval_prompt&quot; =&gt; &quot;&quot; }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#   }</span></span>
<span class="line"><span style="color:#89DDFF;">  {</span></span>
<span class="line"><span style="color:#89DDFF;">    &#39;</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">openid_connect</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    &#39;</span><span style="color:#C3E88D;">label</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">OTN</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> # optional label for login button, defaults to &#39;Openid Connect&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">    &#39;</span><span style="color:#C3E88D;">icon</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">https://main.jtiiot.com:8001/minio-test/otn-file/logo/otn/logo%20(1).png</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    &#39;</span><span style="color:#C3E88D;">args</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  {</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">openid_connect</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#C3E88D;">scope</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">openid</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">profile</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">email</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#C3E88D;">response_type</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">code</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#C3E88D;">issuer</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">https://main.jtiiot.com:8001</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#C3E88D;">discovery</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  true,</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#C3E88D;">client_auth_method</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">query</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#C3E88D;">uid_field</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">preferred_username</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#C3E88D;">send_scope_to_token_endpoint</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  false,</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#C3E88D;">pkce</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;"> true,</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#C3E88D;">client_options</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  {</span></span>
<span class="line"><span style="color:#89DDFF;">        &#39;</span><span style="color:#C3E88D;">identifier</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">73310501fd360a647c7f</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">        &#39;</span><span style="color:#C3E88D;">secret</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">04c2691588e6f1bad0c2e54a3db8808ceb67dd39</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">        &#39;</span><span style="color:#C3E88D;">redirect_uri</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> =&gt;</span><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">http://172.26.27.23:1880/users/auth/openid_connect/callback</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>问题</p><p>OpenIDConnect::Discovery::DiscoveryFailed (SSL_connect returned=1 errno=0 st......</p><p>IDP 一定是https协议（及OIDC提供商必须是https）</p><p>问题 JSON::JWK::Set::KidNotFound</p><p>Casdoor的证书一定是admin(共享)的组织</p><p>问题</p><p>Signing in using your OTN account without a pre-existing GitLab account is not allowed. Create a GitLab account first, and then connect it to your OTN account.</p><p>缺少下面配置</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">gitlab_rails[</span><span style="color:#FFCB6B;">&#39;omniauth_allow_single_sign_on&#39;</span><span style="color:#FFCB6B;">]</span><span style="color:#C3E88D;"> =</span><span style="color:#BABED8;"> [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">openid_connect</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>问题</p><p>Your account is pending approval from your GitLab administrator and hence blocked. Please contact your GitLab administrator if you think this is an error.</p><p>root用户登录，approve通过</p>`,103),r=[t];function c(i,d,u,b,D,m){return n(),a("div",null,r)}const F=s(o,[["render",c]]);export{h as __pageData,F as default};
