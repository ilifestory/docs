import{_ as s,c as n,o as a,a4 as e}from"./chunks/framework.CCJHkvW2.js";const m=JSON.parse('{"title":"NTP","description":"","frontmatter":{},"headers":[],"relativePath":"linux/ntp.md","filePath":"linux/ntp.md","lastUpdated":1713833896000}'),l={name:"linux/ntp.md"},p=e(`<h1 id="ntp" tabindex="-1">NTP <a class="header-anchor" href="#ntp" aria-label="Permalink to &quot;NTP&quot;">​</a></h1><p>参考文献(<a href="https://blog.csdn.net/weixin_45788433/article/details/133930270" target="_blank" rel="noreferrer">https://blog.csdn.net/weixin_45788433/article/details/133930270</a>)(<a href="https://blog.csdn.net/Henry_Lin_Wind/article/details/89467959/" target="_blank" rel="noreferrer">https://blog.csdn.net/Henry_Lin_Wind/article/details/89467959/</a>)</p><p>NTP(Network Time Protocol)是网络时间协议，它的作用是同步网络中每台计算机的时间，使他们处于相同的时间环境，确保服务或软件在计算机中正常运行。</p><p>在ntp时间同步架构中，节点分为服务端（server）和客户端（client），server端配置为ntp时钟源，用来为各个client端提供时间同步功能， client端可通过ntp守护进程ntpd自动跃进式（默认64s）同步server端的时间，也可通过ntpdate服务手动直接同步server端的时间， 需要注意的是当ntpd守护进程运行中时，是无法使用ntpdate的，需要先停止ntpd后再执行ntpdate。ntp client端和ntp server端时间同步使用的是UDP123端口， 因此在安全防护较为严格的生产场景中，需确保网络中的安全设备允许ntp client端和ntp server端的UDP123端口正常通信。</p><h2 id="安裝ntp" tabindex="-1">安裝NTP <a class="header-anchor" href="#安裝ntp" aria-label="Permalink to &quot;安裝NTP&quot;">​</a></h2><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">yum</span><span style="color:#C3E88D;"> -y</span><span style="color:#C3E88D;"> install</span><span style="color:#C3E88D;"> ntp</span><span style="color:#C3E88D;"> ntpdate</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="修改配置" tabindex="-1">修改配置 <a class="header-anchor" href="#修改配置" aria-label="Permalink to &quot;修改配置&quot;">​</a></h2><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">vim</span><span style="color:#C3E88D;"> /etc/ntp.conf</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># For more information about this file, see the man pages</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># ntp.conf(5), ntp_acc(5), ntp_auth(5), ntp_clock(5), ntp_misc(5), ntp_mon(5).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;">driftfile /var/lib/ntp/drift</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Permit time synchronization with our time source, but do not</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># permit the source to query or modify the service on this system.</span></span>
<span class="line"><span style="color:#C3E88D;">restrict default nomodify notrap nopeer noquery</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Permit all access over the loopback interface.  This could</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># be tightened as well, but to do so would effect some of</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># the administrative functions.</span></span>
<span class="line"><span style="color:#C3E88D;">restrict 127.0.0.1</span><span style="color:#BABED8;"> </span></span>
<span class="line"><span style="color:#C3E88D;">restrict ::1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Hosts on local network are less restricted.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;">restrict 0.0.0.0 mask 0.0.0.0 nomodify notrap  \`新增点 允许所有人访问\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Use public servers from the pool.ntp.org project.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span>
<span class="line"><span style="color:#C3E88D;">server ntp1.aliyun.com iburst  \`新增点 阿里云ntp服务器\`</span></span>
<span class="line"><span style="color:#C3E88D;">server 0.centos.pool.ntp.org iburst</span></span>
<span class="line"><span style="color:#C3E88D;">server 1.centos.pool.ntp.org iburst</span></span>
<span class="line"><span style="color:#C3E88D;">server 2.centos.pool.ntp.org iburst</span></span>
<span class="line"><span style="color:#C3E88D;">server 3.centos.pool.ntp.org iburst</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">#</span><span style="color:#C3E88D;">broadcast 192.168.1.255 autokey</span><span style="color:#676E95;font-style:italic;">	# broadcast server</span></span>
<span class="line"><span style="color:#BABED8;">#</span><span style="color:#C3E88D;">broadcastclient</span><span style="color:#676E95;font-style:italic;">			# broadcast client</span></span>
<span class="line"><span style="color:#BABED8;">#</span><span style="color:#C3E88D;">broadcast 224.0.1.1 autokey</span><span style="color:#676E95;font-style:italic;">		# multicast server</span></span>
<span class="line"><span style="color:#BABED8;">#</span><span style="color:#C3E88D;">multicastclient 224.0.1.1</span><span style="color:#676E95;font-style:italic;">		# multicast client</span></span>
<span class="line"><span style="color:#BABED8;">#</span><span style="color:#C3E88D;">manycastserver 239.255.254.254</span><span style="color:#676E95;font-style:italic;">		# manycast server</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#manycastclient 239.255.254.254 autokey # manycast client</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Enable public key cryptography.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#crypto</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;">includefile /etc/ntp/crypto/pw</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Key file containing the keys and key identifiers used when operating</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># with symmetric key cryptography. </span></span>
<span class="line"><span style="color:#C3E88D;">keys /etc/ntp/keys</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Specify the key identifiers which are trusted.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#trustedkey 4 8 42</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Specify the key identifier to use with the ntpdc utility.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#requestkey 8</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Specify the key identifier to use with the ntpq utility.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#controlkey 8</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Enable writing of statistics records.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#statistics clockstats cryptostats loopstats peerstats</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Disable the monitoring facility to prevent amplification attacks using ntpdc</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># monlist command when default restrict does not include the noquery flag. See</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># CVE-2013-5211 for more details.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Note: Monitoring will not be disabled with the limited restriction flag.</span></span>
<span class="line"><span style="color:#C3E88D;">disable monitor</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h3 id="a-修改-restrict" tabindex="-1">a 修改 restrict <a class="header-anchor" href="#a-修改-restrict" aria-label="Permalink to &quot;a  修改 restrict&quot;">​</a></h3><p>去掉注释,修改为 restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap</p><h3 id="b-新增-当外部时间不可用时-使用本地时间" tabindex="-1">b 新增：当外部时间不可用时，使用本地时间 <a class="header-anchor" href="#b-新增-当外部时间不可用时-使用本地时间" aria-label="Permalink to &quot;b  新增：当外部时间不可用时，使用本地时间&quot;">​</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">server</span><span style="color:#F78C6C;"> 127.127.1.0</span></span>
<span class="line"><span style="color:#FFCB6B;">fudge</span><span style="color:#F78C6C;"> 127.127.1.0</span><span style="color:#C3E88D;"> stratum</span><span style="color:#F78C6C;"> 10</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="c-修改配置文件ntpd-自动同步到硬件时间" tabindex="-1">c 修改配置文件ntpd,自动同步到硬件时间 <a class="header-anchor" href="#c-修改配置文件ntpd-自动同步到硬件时间" aria-label="Permalink to &quot;c  修改配置文件ntpd,自动同步到硬件时间&quot;">​</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> vim</span><span style="color:#C3E88D;"> /etc/sysconfig/ntpd</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>添加配置：</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">SYNC_HWCLOCK</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">yes</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="测试" tabindex="-1">测试 <a class="header-anchor" href="#测试" aria-label="Permalink to &quot;测试&quot;">​</a></h2><p>测试服务器安装ntpd</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">yum</span><span style="color:#C3E88D;"> -y</span><span style="color:#C3E88D;"> install</span><span style="color:#C3E88D;"> ntp</span><span style="color:#C3E88D;"> ntpdate</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">ntpdate</span><span style="color:#F78C6C;"> 172.26.22.106</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div>`,21),t=[p];function i(r,c,o,b,d,y){return a(),n("div",null,t)}const h=s(l,[["render",i]]);export{m as __pageData,h as default};
