import{_ as s,c as n,o as a,a4 as l}from"./chunks/framework.CCJHkvW2.js";const A=JSON.parse('{"title":"网关限流","description":"","frontmatter":{},"headers":[],"relativePath":"spring/限流.md","filePath":"spring/限流.md","lastUpdated":1708482714000}'),p={name:"spring/限流.md"},e=l(`<h1 id="网关限流" tabindex="-1">网关限流 <a class="header-anchor" href="#网关限流" aria-label="Permalink to &quot;网关限流&quot;">​</a></h1><pre><code>顾名思义，限流就是限制流量。通过限流，我们可以很好地控制系统的 QPS，从而达到保护系统的目的。

常见的限流算法有：① 计数器算法，② 漏桶（Leaky Bucket）算法，③ 令牌桶（Token Bucket）算法。

Spring Cloud Gateway官方提供了RequestRateLimiterGatewayFilterFactory过滤器工厂，使用Redis 和Lua(保证原子性)脚本实现了令牌桶的方式。
</code></pre><h2 id="普通限流" tabindex="-1">普通限流 <a class="header-anchor" href="#普通限流" aria-label="Permalink to &quot;普通限流&quot;">​</a></h2><h3 id="_1、添加依赖" tabindex="-1">1、添加依赖 <a class="header-anchor" href="#_1、添加依赖" aria-label="Permalink to &quot;1、添加依赖&quot;">​</a></h3><pre><code>&lt;!-- spring data redis reactive 依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><h3 id="_2、限流规则-以uri限流为例" tabindex="-1">2、限流规则 (以URI限流为例) <a class="header-anchor" href="#_2、限流规则-以uri限流为例" aria-label="Permalink to &quot;2、限流规则 (以URI限流为例)&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">spring:</span></span>
<span class="line"><span style="color:#FFCB6B;">  redis:</span></span>
<span class="line"><span style="color:#FFCB6B;">    host:</span><span style="color:#C3E88D;"> localhost</span></span>
<span class="line"><span style="color:#FFCB6B;">    port:</span><span style="color:#F78C6C;"> 6379</span></span>
<span class="line"><span style="color:#FFCB6B;">    password:</span><span style="color:#BABED8;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">  cloud:</span></span>
<span class="line"><span style="color:#FFCB6B;">    gateway:</span></span>
<span class="line"><span style="color:#FFCB6B;">      routes:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        # 系统模块</span></span>
<span class="line"><span style="color:#FFCB6B;">        -</span><span style="color:#C3E88D;"> id:</span><span style="color:#C3E88D;"> lingcloud-system</span></span>
<span class="line"><span style="color:#FFCB6B;">          uri:</span><span style="color:#C3E88D;"> lb://lingcloud-system</span></span>
<span class="line"><span style="color:#FFCB6B;">          predicates:</span></span>
<span class="line"><span style="color:#FFCB6B;">            -</span><span style="color:#C3E88D;"> Path=/system/</span><span style="color:#BABED8;">**</span></span>
<span class="line"><span style="color:#FFCB6B;">          filters:</span></span>
<span class="line"><span style="color:#FFCB6B;">            -</span><span style="color:#C3E88D;"> StripPrefix=</span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#FFCB6B;">            -</span><span style="color:#C3E88D;"> name:</span><span style="color:#C3E88D;"> RequestRateLimiter</span></span>
<span class="line"><span style="color:#FFCB6B;">              args:</span></span>
<span class="line"><span style="color:#FFCB6B;">                redis-rate-limiter.replenishRate:</span><span style="color:#F78C6C;"> 1</span><span style="color:#676E95;font-style:italic;"> # 令牌桶每秒填充速率</span></span>
<span class="line"><span style="color:#FFCB6B;">                redis-rate-limiter.burstCapacity:</span><span style="color:#F78C6C;"> 2</span><span style="color:#676E95;font-style:italic;"> # 令牌桶总容量</span></span>
<span class="line"><span style="color:#FFCB6B;">                key-resolver:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">#{@pathKeyResolver}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#676E95;font-style:italic;"> # 使用 SpEL 表达式按名称引用 bean</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                #key-resolver: &quot;#{@parameterKeyResolver}&quot; # userId限流</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                #key-resolver: &quot;#{@parameterKeyResolver}&quot; # IP限流</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">StripPrefix=1</p><p>StripPrefix=1配置，表示网关转发到业务模块时候会自动截取前缀。</p></div><h3 id="_3、编写限流规则配置类" tabindex="-1">3、编写限流规则配置类 <a class="header-anchor" href="#_3、编写限流规则配置类" aria-label="Permalink to &quot;3、编写限流规则配置类&quot;">​</a></h3><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#F78C6C;">package</span><span style="color:#C792EA;"> com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">lingcloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">gateway</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">config</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">gateway</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">filter</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">ratelimit</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">KeyResolver</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">context</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">annotation</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Bean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">context</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">annotation</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Configuration</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> reactor</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">core</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">publisher</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * 限流规则配置类</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Configuration</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> KeyResolverConfiguration</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    @</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#C792EA;">    public</span><span style="color:#C792EA;"> KeyResolver</span><span style="color:#82AAFF;"> pathKeyResolver</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        return</span><span style="color:#BABED8;"> exchange </span><span style="color:#C792EA;">-&gt;</span><span style="color:#BABED8;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">just</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">exchange</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getRequest</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getURI</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getPath</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    </span></span>
<span class="line"><span style="color:#89DDFF;">    @</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#C792EA;">    public</span><span style="color:#C792EA;"> KeyResolver</span><span style="color:#82AAFF;"> parameterKeyResolver</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">	    return</span><span style="color:#BABED8;"> exchange </span><span style="color:#C792EA;">-&gt;</span><span style="color:#BABED8;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">just</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">exchange</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getRequest</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getQueryParams</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getFirst</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">userId</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    @</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#C792EA;">    public</span><span style="color:#C792EA;"> KeyResolver</span><span style="color:#82AAFF;"> ipKeyResolver</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">	    return</span><span style="color:#BABED8;"> exchange </span><span style="color:#C792EA;">-&gt;</span><span style="color:#BABED8;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">just</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">exchange</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getRequest</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getRemoteAddress</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">getHostName</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_4、测试服务验证限流" tabindex="-1">4、测试服务验证限流 <a class="header-anchor" href="#_4、测试服务验证限流" aria-label="Permalink to &quot;4、测试服务验证限流&quot;">​</a></h3><p>启动网关服务GatewayApplication和系统服务RSystemApplication。</p><p>因为网关服务有认证鉴权，可以设置一下白名单/system/**在进行测试，多次请求会发现返回HTTP ERROR 429，同时在redis中会操作两个key，表示限流成功。</p><pre><code>request_rate_limiter.{xxx}.timestamp
request_rate_limiter.{xxx}.tokens
</code></pre><h2 id="sentinel限流" tabindex="-1">Sentinel限流 <a class="header-anchor" href="#sentinel限流" aria-label="Permalink to &quot;Sentinel限流&quot;">​</a></h2><pre><code>Sentinel 支持对 Spring Cloud Gateway、Netflix Zuul 等主流的 API Gateway 进行限流。
</code></pre><h3 id="_1、添加依赖-1" tabindex="-1">1、添加依赖 <a class="header-anchor" href="#_1、添加依赖-1" aria-label="Permalink to &quot;1、添加依赖&quot;">​</a></h3><pre><code>&lt;!-- SpringCloud Alibaba Sentinel --&gt; 阿里巴巴sentinel包
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- SpringCloud Alibaba Sentinel Gateway --&gt;  sentinel集成gateway包
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-alibaba-sentinel-gateway&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><h3 id="_2、限流规则配置类" tabindex="-1">2、限流规则配置类 <a class="header-anchor" href="#_2、限流规则配置类" aria-label="Permalink to &quot;2、限流规则配置类&quot;">​</a></h3><pre><code>① 添加SentinelGatewayFilter过滤器

② 创建SentinelFallbackHandler掌控者

③ 初始化限流规则 initGatewayRules

④ 若分组限流,设置分组限流规则
</code></pre><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#F78C6C;">package</span><span style="color:#C792EA;"> com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">lingcloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">gateway</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">config</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">util</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">HashSet</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">util</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Set</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> javax</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">annotation</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">PostConstruct</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">gateway</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">filter</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">GlobalFilter</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">context</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">annotation</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Bean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">context</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">annotation</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Configuration</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">core</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Ordered</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">core</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">annotation</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Order</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">alibaba</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">csp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sentinel</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">adapter</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">gateway</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">common</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">rule</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">GatewayFlowRule</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">alibaba</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">csp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sentinel</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">adapter</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">gateway</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">common</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">rule</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">GatewayRuleManager</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">alibaba</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">csp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sentinel</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">adapter</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">gateway</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sc</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">SentinelGatewayFilter</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">lingcloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">gateway</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">handler</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">SentinelFallbackHandler</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * 网关限流配置</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#F78C6C;font-style:italic;">@author</span><span style="color:#676E95;font-style:italic;"> zhangling</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#C792EA;">Configuration</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> GatewayConfig</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    @</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#89DDFF;">    @</span><span style="color:#C792EA;">Order</span><span style="color:#89DDFF;">(-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">    public</span><span style="color:#C792EA;"> GlobalFilter</span><span style="color:#82AAFF;"> sentinelGatewayFilter</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        return</span><span style="color:#89DDFF;font-style:italic;"> new</span><span style="color:#82AAFF;"> SentinelGatewayFilter</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    </span></span>
<span class="line"><span style="color:#89DDFF;">    @</span><span style="color:#C792EA;">Bean</span></span>
<span class="line"><span style="color:#89DDFF;">    @</span><span style="color:#C792EA;">Order</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">Ordered</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">HIGHEST_PRECEDENCE</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">    public</span><span style="color:#C792EA;"> SentinelFallbackHandler</span><span style="color:#82AAFF;"> sentinelGatewayExceptionHandler</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        return</span><span style="color:#89DDFF;font-style:italic;"> new</span><span style="color:#82AAFF;"> SentinelFallbackHandler</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    @</span><span style="color:#C792EA;">PostConstruct</span></span>
<span class="line"><span style="color:#C792EA;">    public</span><span style="color:#C792EA;"> void</span><span style="color:#82AAFF;"> doInit</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // 加载网关限流规则</span></span>
<span class="line"><span style="color:#82AAFF;">        initGatewayRules</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 网关限流规则   </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#C792EA;">    private</span><span style="color:#C792EA;"> void</span><span style="color:#82AAFF;"> initGatewayRules</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#C792EA;">        Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">GatewayFlowRule</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> rules </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;font-style:italic;"> new</span><span style="color:#C792EA;"> HashSet</span><span style="color:#89DDFF;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#BABED8;">        rules</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#82AAFF;"> GatewayFlowRule</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">lingcloud-system</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">                .</span><span style="color:#82AAFF;">setCount</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">)</span><span style="color:#676E95;font-style:italic;"> // 限流阈值</span></span>
<span class="line"><span style="color:#89DDFF;">                .</span><span style="color:#82AAFF;">setIntervalSec</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">60</span><span style="color:#89DDFF;">));</span><span style="color:#676E95;font-style:italic;"> // 统计时间窗口，单位是秒，默认是 1 秒</span></span>
<span class="line"><span style="color:#BABED8;">        rules</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#82AAFF;"> GatewayFlowRule</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">system-api</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#676E95;font-style:italic;"> // 名称为system-api 组</span></span>
<span class="line"><span style="color:#89DDFF;">                .</span><span style="color:#82AAFF;">setCount</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">)</span><span style="color:#676E95;font-style:italic;"> // 限流阈值</span></span>
<span class="line"><span style="color:#89DDFF;">                .</span><span style="color:#82AAFF;">setIntervalSec</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">60</span><span style="color:#89DDFF;">));</span><span style="color:#676E95;font-style:italic;"> // 统计时间窗口，单位是秒，默认是 1 秒</span></span>
<span class="line"><span style="color:#BABED8;">        rules</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#82AAFF;"> GatewayFlowRule</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">code-api</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#676E95;font-style:italic;"> // 名称为code-api 组</span></span>
<span class="line"><span style="color:#89DDFF;">                .</span><span style="color:#82AAFF;">setCount</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">)</span><span style="color:#676E95;font-style:italic;"> // 限流阈值</span></span>
<span class="line"><span style="color:#89DDFF;">                .</span><span style="color:#82AAFF;">setIntervalSec</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">60</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // 加载网关限流规则</span></span>
<span class="line"><span style="color:#BABED8;">        GatewayRuleManager</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">loadRules</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">rules</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // 加载限流分组</span></span>
<span class="line"><span style="color:#82AAFF;">        initCustomizedGroup</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 限流分组   </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#C792EA;">    private</span><span style="color:#C792EA;"> void</span><span style="color:#82AAFF;"> initCustomizedGroup</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#C792EA;">        Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">ApiDefinition</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> definitions </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;font-style:italic;"> new</span><span style="color:#C792EA;"> HashSet</span><span style="color:#89DDFF;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // system-api 组(lingcloud-system的user的所有接口限流)</span></span>
<span class="line"><span style="color:#C792EA;">        ApiDefinition</span><span style="color:#BABED8;"> api1 </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;font-style:italic;"> new</span><span style="color:#82AAFF;"> ApiDefinition</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">system-api</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">setPredicateItems</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#C792EA;"> HashSet</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">ApiPredicateItem</span><span style="color:#89DDFF;">&gt;()</span></span>
<span class="line"><span style="color:#89DDFF;">        {</span></span>
<span class="line"><span style="color:#C792EA;">            private</span><span style="color:#C792EA;"> static</span><span style="color:#C792EA;"> final</span><span style="color:#C792EA;"> long</span><span style="color:#BABED8;"> serialVersionUID </span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;"> 1L</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">            {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                // 匹配 /user 以及其子路径的所有请求</span></span>
<span class="line"><span style="color:#82AAFF;">                add</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#82AAFF;"> ApiPathPredicateItem</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">setPattern</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/system/user/**</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">                        .</span><span style="color:#82AAFF;">setMatchStrategy</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">SentinelGatewayConstants</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">URL_MATCH_STRATEGY_PREFIX</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">            }</span></span>
<span class="line"><span style="color:#89DDFF;">        });</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // code-api 组(lingcloud-gen的code/gen/list接口限流)</span></span>
<span class="line"><span style="color:#C792EA;">        ApiDefinition</span><span style="color:#BABED8;"> api2 </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;font-style:italic;"> new</span><span style="color:#82AAFF;"> ApiDefinition</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">code-api</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">setPredicateItems</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#C792EA;"> HashSet</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">ApiPredicateItem</span><span style="color:#89DDFF;">&gt;()</span></span>
<span class="line"><span style="color:#89DDFF;">        {</span></span>
<span class="line"><span style="color:#C792EA;">            private</span><span style="color:#C792EA;"> static</span><span style="color:#C792EA;"> final</span><span style="color:#C792EA;"> long</span><span style="color:#BABED8;"> serialVersionUID </span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;"> 1L</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">            {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">                // 只匹配 /gen/list</span></span>
<span class="line"><span style="color:#82AAFF;">                add</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#82AAFF;"> ApiPathPredicateItem</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">setPattern</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/code/gen/list</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">            }</span></span>
<span class="line"><span style="color:#89DDFF;">        });</span></span>
<span class="line"><span style="color:#BABED8;">        definitions</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">api1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">        definitions</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">api2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // 加载限流分组</span></span>
<span class="line"><span style="color:#BABED8;">        GatewayApiDefinitionManager</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">loadApiDefinitions</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">definitions</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#F78C6C;">package</span><span style="color:#C792EA;"> com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">lingcloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">gateway</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">handler</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">nio</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">charset</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">StandardCharsets</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">alibaba</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">csp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sentinel</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">adapter</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">gateway</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sc</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">callback</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">GatewayCallbackManager</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">alibaba</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">csp</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sentinel</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">slots</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">block</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">BlockException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">core</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">io</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">buffer</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">DataBuffer</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">http</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">server</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">reactive</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">ServerHttpResponse</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">web</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">reactive</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">server</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">ServerResponse</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">web</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">server</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">ServerWebExchange</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">web</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">server</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">WebExceptionHandler</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#C792EA;"> reactor</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">core</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">publisher</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Mono</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * 自定义限流异常处理</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#F78C6C;font-style:italic;">@author</span><span style="color:#676E95;font-style:italic;"> zhangling</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> SentinelFallbackHandler</span><span style="color:#C792EA;"> implements</span><span style="color:#FFCB6B;"> WebExceptionHandler</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">    private</span><span style="color:#C792EA;"> Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#82AAFF;"> writeResponse</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ServerResponse</span><span style="color:#BABED8;font-style:italic;"> response</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> ServerWebExchange</span><span style="color:#BABED8;font-style:italic;"> exchange</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#C792EA;">        ServerHttpResponse</span><span style="color:#BABED8;"> serverHttpResponse </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> exchange</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getResponse</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">        serverHttpResponse</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getHeaders</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Content-Type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">application/json;charset=UTF-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">        byte</span><span style="color:#89DDFF;">[]</span><span style="color:#BABED8;"> datas </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">{</span><span style="color:#BABED8;">\\&quot;</span><span style="color:#C3E88D;">code</span><span style="color:#BABED8;">\\&quot;</span><span style="color:#C3E88D;">:429,</span><span style="color:#BABED8;">\\&quot;</span><span style="color:#C3E88D;">msg</span><span style="color:#BABED8;">\\&quot;</span><span style="color:#C3E88D;">:</span><span style="color:#BABED8;">\\&quot;</span><span style="color:#C3E88D;">请求超过最大数，请稍后再试</span><span style="color:#BABED8;">\\&quot;</span><span style="color:#C3E88D;">}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBytes</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">StandardCharsets</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">UTF_8</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#C792EA;">        DataBuffer</span><span style="color:#BABED8;"> buffer </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> serverHttpResponse</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bufferFactory</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">wrap</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">datas</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        return</span><span style="color:#BABED8;"> serverHttpResponse</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeWith</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">just</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">buffer</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    @</span><span style="color:#C792EA;">Override</span></span>
<span class="line"><span style="color:#C792EA;">    public</span><span style="color:#C792EA;"> Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Void</span><span style="color:#89DDFF;">&gt;</span><span style="color:#82AAFF;"> handle</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ServerWebExchange</span><span style="color:#BABED8;font-style:italic;"> exchange</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> Throwable</span><span style="color:#BABED8;font-style:italic;"> ex</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        if</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;">exchange</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getResponse</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">isCommitted</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#89DDFF;">        {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">            return</span><span style="color:#BABED8;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">ex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">        }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        if</span><span style="color:#89DDFF;"> (!</span><span style="color:#BABED8;">BlockException</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isBlockException</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">ex</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#89DDFF;">        {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">            return</span><span style="color:#BABED8;"> Mono</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">error</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">ex</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">        }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        return</span><span style="color:#82AAFF;"> handleBlockedRequest</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">exchange</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> ex</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">flatMap</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">response </span><span style="color:#C792EA;">-&gt;</span><span style="color:#82AAFF;"> writeResponse</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">response</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> exchange</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">    private</span><span style="color:#C792EA;"> Mono</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">ServerResponse</span><span style="color:#89DDFF;">&gt;</span><span style="color:#82AAFF;"> handleBlockedRequest</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">ServerWebExchange</span><span style="color:#BABED8;font-style:italic;"> exchange</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;"> Throwable</span><span style="color:#BABED8;font-style:italic;"> throwable</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        return</span><span style="color:#BABED8;"> GatewayCallbackManager</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getBlockHandler</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">handleRequest</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">exchange</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> throwable</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="_3、测试验证" tabindex="-1">3、测试验证 <a class="header-anchor" href="#_3、测试验证" aria-label="Permalink to &quot;3、测试验证&quot;">​</a></h3><pre><code>lingcloud-system限流结果:

一分钟内访问三次系统服务出现异常提示表示限流成功。

分组限流结果:

访问：http://localhost:8080/system/user/list （触发限流 ）

访问：http://localhost:8080/system/role/list （不会触发限流）

访问：http://localhost:8080/code/gen/list （触发限流）

访问：http://localhost:8080/code/gen/xxxx （不会触发限流）
</code></pre><div class="tip custom-block"><p class="custom-block-title">Sentinel自定义异常</p><p>方案一：yml配置</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># Spring</span></span>
<span class="line"><span style="color:#FFCB6B;">spring:</span><span style="color:#BABED8;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">  cloud:</span></span>
<span class="line"><span style="color:#FFCB6B;">    sentinel:</span></span>
<span class="line"><span style="color:#FFCB6B;">      scg:</span></span>
<span class="line"><span style="color:#FFCB6B;">        fallback:</span></span>
<span class="line"><span style="color:#FFCB6B;">          mode:</span><span style="color:#C3E88D;"> response</span></span>
<span class="line"><span style="color:#FFCB6B;">          response-body:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">{&quot;code&quot;:403,&quot;msg&quot;:&quot;请求超过最大数，请稍后再试&quot;}</span><span style="color:#89DDFF;">&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>方案二：GatewayConfig注入Bean</p><pre><code>    关注上面的 SentinelFallbackHandler.java 类
</code></pre></div>`,25),o=[e];function r(t,c,F,y,i,D){return a(),n("div",null,o)}const u=s(p,[["render",r]]);export{A as __pageData,u as default};
